<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard OmniChat (via n8n)</title>
    <style>
        :root { --primary: #2563eb; --danger: #dc2626; --success: #16a34a; --warning: #d97706; --gray: #6b7280; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f9fafb; padding: 20px; color: #111827; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; border-left: 6px solid var(--primary); }
        .header h1 { color: var(--primary); margin-bottom: 10px; }
        .config-warning { background: #fef3c7; border: 1px solid var(--warning); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.95rem; }
        .config-warning code { background: #f5f5f5; padding: 2px 6px; border-radius: 4px; }
        .controls { display: flex; gap: 12px; margin-bottom: 25px; }
        button { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { opacity: 0.9; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .status-bar { display: flex; align-items: center; gap: 10px; padding: 15px; background: #f3f4f6; border-radius: 8px; margin-bottom: 25px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.online { background: var(--success); }
        .status-dot.offline { background: var(--danger); }
        .status-dot.loading { background: var(--warning); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
        .error-box { background: #fee2e2; color: var(--danger); padding: 20px; border-radius: 8px; margin-bottom: 25px; display: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 25px 0; }
        .kpi-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
        .kpi-value { font-size: 36px; font-weight: 800; margin: 10px 0; color: var(--primary); }
        .kpi-label { color: var(--gray); font-size: 14px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-top: 15px; }
        th { background: #f9fafb; text-align: left; padding: 16px; border-bottom: 2px solid #e5e7eb; }
        td { padding: 16px; border-bottom: 1px solid #f3f4f6; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .loading { text-align: center; padding: 50px 20px; color: var(--gray); }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .empty { text-align: center; padding: 40px 20px; color: var(--gray); font-style: italic; }
        .section { margin: 30px 0; }
        .raw-data { background: #f8fafc; padding: 20px; border-radius: 10px; margin-top: 30px; font-family: monospace; font-size: 13px; max-height: 300px; overflow-y: auto; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard OmniChat</h1>
            <p>Dados detalhados dos atendimentos, utilizando o poder da IA para gerar insights.</p>

            <div class="status-bar">
                <div class="status-dot offline" id="statusDot"></div>
                <span id="statusText">Configure as URLs acima e clique para carregar</span>
            </div>
        </div>

        <div class="error-box" id="errorBox">
            <strong>‚ùå Erro:</strong> <span id="errorMessage"></span>
            <pre id="errorDetails" style="margin-top:10px;background:#fca5a5;padding:10px;border-radius:5px;display:none;"></pre>
        </div>

        <div class="controls">
            <button class="btn-primary" onclick="loadAllData()" id="loadBtn">
                üîÑ Carregar Dados via n8n
            </button>
            <button class="btn-secondary" onclick="toggleRawData()">
                üìÑ Ver Dados Brutos
            </button>
        </div>

        <div class="grid">
            <div class="kpi-card"><div class="kpi-value" id="kpiAgents">0</div><div class="kpi-label">Atendentes</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpiChats">0</div><div class="kpi-label">Conversas</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpiOnline">0</div><div class="kpi-label">Ativos</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpiUpdated">--:--</div><div class="kpi-label">Atualizado</div></div>
        </div>

        <div class="section">
            <h2>üë• Atendentes</h2>
            <div class="loading" id="loadingAgents"><div class="loading-spinner"></div><p>Buscando...</p></div>
            <div id="emptyAgents" class="empty" style="display:none;">Nenhum atendente</div>
            <table id="agentsTable" style="display:none;">
                <thead><tr><th>Nome</th><th>Status</th><th>Email</th><th>Criado em</th></tr></thead>
                <tbody id="agentsTableBody"></tbody>
            </table>
        </div>

        <div class="section">
            <h2>üí¨ Conversas Recentes</h2>
            <div class="loading" id="loadingChats"><div class="loading-spinner"></div><p>Buscando...</p></div>
            <div id="emptyChats" class="empty" style="display:none;">Nenhuma conversa</div>
            <table id="chatsTable" style="display:none;">
                <thead><tr><th>Cliente</th><th>Plataforma</th><th>Status</th><th>√öltima Mensagem</th><th>Criada</th></tr></thead>
                <tbody id="chatsTableBody"></tbody>
            </table>
        </div>

        <div class="raw-data" id="rawData"><strong>Dados Recebidos:</strong><pre id="rawDataContent"></pre></div>
    </div>

    <script>
        // ============================================================================
        // 1. CONFIGURA√á√ÉO - DEFINA AS URLs DOS SEUS WEBHOOKS DO N8N AQUI
        // ============================================================================
        // ‚ö†Ô∏è SUBSTITUA pelo dom√≠nio real do seu n8n Cloud ou servidor.
        // No console do navegador, defina:
        window.N8N_WEBHOOK_URL = 'https://api.muvecom.com.br';
        window.WEBHOOK_PATH_AGENTS = '/v1/omnichat-agents';
        window.WEBHOOK_PATH_CHATS = '/v1/omnichat-chats';
        const CONFIG = {
            // URL base do seu n8n (Cloud ou self-hosted)
            N8N_BASE_URL: window.N8N_WEBHOOK_URL || '', // Ex: 'https://xyz.app.n8n.cloud'
            // Caminhos dos webhooks que voc√™ criar√°
            WEBHOOKS: {
                AGENTS: window.WEBHOOK_PATH_AGENTS || '', // Ex: '/webhook/omnichat-agents'
                CHATS: window.WEBHOOK_PATH_CHATS || ''    // Ex: '/webhook/omnichat-chats'
            }
        };
        let lastData = null;

        // ============================================================================
        // 2. FUN√á√ÉO PRINCIPAL - BUSCA DADOS DOS WEBHOOKS
        // ============================================================================
        async function loadAllData() {
            // Valida configura√ß√£o
            if (!CONFIG.N8N_BASE_URL || !CONFIG.WEBHOOKS.AGENTS) {
                showError('Configure primeiro as URLs do n8n. Veja o aviso amarelo no topo da p√°gina.', '');
                return;
            }
            // Reset UI
            hideError();
            updateStatus('Conectando ao n8n...', 'loading');
            document.getElementById('loadBtn').disabled = true;
            document.getElementById('loadBtn').innerHTML = 'üîÑ Buscando...';
            showLoading('agents', true); showLoading('chats', true);
            hideTable('agents'); hideTable('chats'); hideEmpty('agents'); hideEmpty('chats');
            resetKPIs();

            try {
                // Busca em paralelo
                const [agentsData, chatsData] = await Promise.all([
                    fetchFromN8N(CONFIG.WEBHOOKS.AGENTS),
                    fetchFromN8N(CONFIG.WEBHOOKS.CHATS)
                ]);
                // Processa respostas
                processAgents(agentsData);
                processChats(chatsData);
                updateKPIs(agentsData, chatsData);
                updateStatus('‚úÖ Dados carregados via n8n', 'online');
                updateTime();
                // Guarda para debug
                lastData = { agents: agentsData, chats: chatsData, time: new Date().toISOString() };
            } catch (error) {
                console.error('Erro:', error);
                showError(`Falha ao buscar dados: ${error.message}`, error.stack);
                updateStatus('‚ùå Erro no servidor n8n', 'offline');
            } finally {
                document.getElementById('loadBtn').disabled = false;
                document.getElementById('loadBtn').innerHTML = 'üîÑ Carregar Dados via n8n';
            }
        }

        async function fetchFromN8N(webhookPath) {
            const url = CONFIG.N8N_BASE_URL + webhookPath;
            const response = await fetch(url, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`n8n (${response.status}): ${errorText.substring(0, 100)}`);
            }
            return await response.json();
        }

        // ============================================================================
        // 3. PROCESSAMENTO DOS DADOS RECEBIDOS DO N8N
        // ============================================================================
        function processAgents(data) {
            const tbody = document.getElementById('agentsTableBody');
            const loading = document.getElementById('loadingAgents');
            const table = document.getElementById('agentsTable');
            const empty = document.getElementById('emptyAgents');
            tbody.innerHTML = ''; loading.style.display = 'none'; table.style.display = 'none'; empty.style.display = 'none';

            // Sup√µe que o n8n retorna { success: true, data: [...] } ou array direto
            const agents = data.data || data.results || data;
            if (!Array.isArray(agents) || agents.length === 0) {
                empty.style.display = 'block'; return;
            }
            agents.forEach(agent => {
                const row = document.createElement('tr');
                const isActive = agent.disabled === false || agent.status === 'online';
                const statusBadge = isActive ? '<span class="badge badge-success">Ativo</span>' : '<span class="badge badge-danger">Inativo</span>';
                const created = agent.createdAt ? new Date(agent.createdAt).toLocaleDateString('pt-BR') : '--';
                row.innerHTML = `<td><strong>${agent.name || 'Sem nome'}</strong></td>
                                 <td>${statusBadge}</td>
                                 <td>${agent.email || '--'}</td>
                                 <td>${created}</td>`;
                tbody.appendChild(row);
            });
            table.style.display = 'table';
        }

        function processChats(data) {
            const tbody = document.getElementById('chatsTableBody');
            const loading = document.getElementById('loadingChats');
            const table = document.getElementById('chatsTable');
            const empty = document.getElementById('emptyChats');
            tbody.innerHTML = ''; loading.style.display = 'none'; table.style.display = 'none'; empty.style.display = 'none';

            const chats = data.data || data.results || data;
            if (!Array.isArray(chats) || chats.length === 0) {
                empty.style.display = 'block'; return;
            }
            chats.slice(0, 15).forEach(chat => {
                const row = document.createElement('tr');
                let statusBadge = '<span class="badge badge-warning">Ativa</span>';
                if (chat.status === 'FINISHED') statusBadge = '<span class="badge badge-danger">Finalizada</span>';
                if (chat.status === 'UNASSIGNED') statusBadge = '<span class="badge badge-warning">N√£o Atribu√≠da</span>';
                const lastMsg = chat.lastMessage ? (chat.lastMessage.text || 'Anexo').substring(0,50)+'...' : '--';
                const created = chat.createdAt ? new Date(chat.createdAt).toLocaleDateString('pt-BR') : '--';
                row.innerHTML = `<td>${chat.name || chat.phone || 'Cliente'}</td>
                                 <td>${chat.platform || '--'}</td>
                                 <td>${statusBadge}</td>
                                 <td title="${lastMsg}">${lastMsg}</td>
                                 <td>${created}</td>`;
                tbody.appendChild(row);
            });
            table.style.display = 'table';
        }

        function updateKPIs(agentsData, chatsData) {
            const agents = agentsData.data || agentsData.results || agentsData || [];
            const chats = chatsData.data || chatsData.results || chatsData || [];
            document.getElementById('kpiAgents').textContent = agents.length;
            document.getElementById('kpiChats').textContent = chats.length;
            const active = agents.filter(a => a.disabled === false || a.status === 'online').length;
            document.getElementById('kpiOnline').textContent = active;
        }

        // ============================================================================
        // 4. FUN√á√ïES AUXILIARES DA UI
        // ============================================================================
        function updateStatus(text, type) {
            const dot = document.getElementById('statusDot');
            const textElem = document.getElementById('statusText');
            dot.className = 'status-dot ' + type;
            textElem.textContent = text;
        }
        function updateTime() {
            const now = new Date();
            document.getElementById('kpiUpdated').textContent = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
        }
        function resetKPIs() {
            document.getElementById('kpiAgents').textContent = '0';
            document.getElementById('kpiChats').textContent = '0';
            document.getElementById('kpiOnline').textContent = '0';
            document.getElementById('kpiUpdated').textContent = '--:--';
        }
        function showError(msg, details) {
            document.getElementById('errorMessage').textContent = msg;
            const det = document.getElementById('errorDetails');
            if (details) { det.textContent = details; det.style.display = 'block'; } else { det.style.display = 'none'; }
            document.getElementById('errorBox').style.display = 'block';
        }
        function hideError() { document.getElementById('errorBox').style.display = 'none'; }
        function showLoading(type, show) { document.getElementById(`loading${type.charAt(0).toUpperCase()+type.slice(1)}`).style.display = show ? 'block' : 'none'; }
        function hideTable(type) { document.getElementById(`${type}Table`).style.display = 'none'; }
        function hideEmpty(type) { document.getElementById(`empty${type.charAt(0).toUpperCase()+type.slice(1)}`).style.display = 'none'; }
        function toggleRawData() {
            const rd = document.getElementById('rawData');
            rd.style.display = rd.style.display === 'block' ? 'none' : 'block';
            if (rd.style.display === 'block' && lastData) {
                document.getElementById('rawDataContent').textContent = JSON.stringify(lastData, null, 2);
            }
        }

        // ============================================================================
        // 5. INICIALIZA√á√ÉO E CARREGAMENTO AUTOM√ÅTICO
        // ============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            // Atualiza o status baseado na configura√ß√£o
            if (!CONFIG.N8N_BASE_URL) {
                updateStatus('‚ö†Ô∏è Configure as URLs do n8n', 'offline');
                // Mesmo sem config, tenta carregar ap√≥s um curto delay para debug
                setTimeout(() => {
                    console.log("Configura√ß√£o N8N_BASE_URL:", CONFIG.N8N_BASE_URL);
                    console.log("URL completa Agents:", CONFIG.N8N_BASE_URL + CONFIG.WEBHOOKS.AGENTS);
                }, 1000);
            } else {
                updateStatus('üîÑ Carregando dados...', 'loading');
                // CARREGA OS DADOS AUTOMATICAMENTE AP√ìS 1 SEGUNDO (pode ajustar o tempo)
                setTimeout(loadAllData, 1000);
            }
        });
        // Chama a fun√ß√£o tamb√©m diretamente para garantir (fallback)
        window.onload = loadAllData;
    </script>
</body>
</html>
