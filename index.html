<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard OmniChat</title>
    <style>
        :root { --primary: #2563eb; --danger: #dc2626; --success: #16a34a; --warning: #d97706; --gray: #6b7280; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f9fafb; padding: 20px; color: #111827; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; border-left: 6px solid var(--primary); }
        .header h1 { color: var(--primary); margin-bottom: 10px; }
        .config-warning { background: #fef3c7; border: 1px solid var(--warning); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.95rem; }
        .config-warning code { background: #f5f5f5; padding: 2px 6px; border-radius: 4px; }
        .controls { display: flex; gap: 12px; margin-bottom: 25px; }
        button { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { opacity: 0.9; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .status-bar { display: flex; align-items: center; gap: 10px; padding: 15px; background: #f3f4f6; border-radius: 8px; margin-bottom: 25px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.online { background: var(--success); }
        .status-dot.offline { background: var(--danger); }
        .status-dot.loading { background: var(--warning); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
        .error-box { background: #fee2e2; color: var(--danger); padding: 20px; border-radius: 8px; margin-bottom: 25px; display: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 25px 0; }
        .kpi-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
        .kpi-value { font-size: 36px; font-weight: 800; margin: 10px 0; color: var(--primary); }
        .kpi-label { color: var(--gray); font-size: 14px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-top: 15px; }
        th { background: #f9fafb; text-align: left; padding: 16px; border-bottom: 2px solid #e5e7eb; }
        td { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #e0f2fe; color: #0c4a6e; }
        .loading { text-align: center; padding: 50px 20px; color: var(--gray); }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .empty { text-align: center; padding: 40px 20px; color: var(--gray); font-style: italic; }
        .section { margin: 30px 0; }
        .raw-data { background: #f8fafc; padding: 20px; border-radius: 10px; margin-top: 30px; font-family: monospace; font-size: 13px; max-height: 300px; overflow-y: auto; display: none; }
        .team-name { background: #f0f9ff; color: #0369a1; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .last-message { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .platform-badge { background: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .agent-name { font-weight: 600; }
        .customer-name { font-weight: 600; margin-bottom: 4px; }
        .customer-phone { font-size: 12px; color: var(--gray); }
        .chat-row:hover { background-color: #f8fafc; }
        .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-select { padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db; background: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard OmniChat</h1>
            <p>Monitoramento de conversas em tempo real - Formato API OmniChat</p>

            <div class="status-bar">
                <div class="status-dot offline" id="statusDot"></div>
                <span id="statusText">Aguardando configura√ß√£o</span>
            </div>
        </div>

        <div class="error-box" id="errorBox">
            <strong>‚ùå Erro:</strong> <span id="errorMessage"></span>
            <pre id="errorDetails" style="margin-top:10px;background:#fca5a5;padding:10px;border-radius:5px;display:none;"></pre>
        </div>

        <div class="controls">
            <button class="btn-primary" onclick="loadOmnichatData()" id="loadBtn">
                üîÑ Carregar Dados OmniChat
            </button>
            <button class="btn-secondary" onclick="toggleRawData()">
                üìÑ Ver Dados Brutos
            </button>
        </div>

        <div class="grid">
            <div class="kpi-card"><div class="kpi-value" id="kpiTotalChats">0</div><div class="kpi-label">Total Conversas</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpiActiveChats">0</div><div class="kpi-label">Ativas Agora</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpiWaiting">0</div><div class="kpi-label">Aguardando</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpiAgents">0</div><div class="kpi-label">Agentes Ativos</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpiUpdated">--:--</div><div class="kpi-label">Atualizado</div></div>
        </div>

        <div class="section">
            <h2>üë• Agentes/Usu√°rios</h2>
            <div class="loading" id="loadingAgents"><div class="loading-spinner"></div><p>Buscando agentes...</p></div>
            <div id="emptyAgents" class="empty" style="display:none;">Nenhum agente encontrado</div>
            <table id="agentsTable" style="display:none;">
                <thead><tr><th>Nome</th><th>Tipo</th><th>Status</th><th>Email</th><th>Criado em</th></tr></thead>
                <tbody id="agentsTableBody"></tbody>
            </table>
        </div>

        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">üí¨ Conversas Recentes</h2>
                <div class="filters">
                    <select class="filter-select" id="filterStatus" onchange="filterChats()">
                        <option value="all">Todos os status</option>
                        <option value="USER">Em Atendimento</option>
                        <option value="TEAM">Na Equipe</option>
                        <option value="FINISHED">Finalizadas</option>
                        <option value="WAITING">Aguardando</option>
                    </select>
                    <select class="filter-select" id="filterPlatform" onchange="filterChats()">
                        <option value="all">Todas plataformas</option>
                        <option value="WAB-OMNICHAT">WhatsApp</option>
                        <option value="INSTAGRAM">Instagram</option>
                        <option value="FACEBOOK">Facebook</option>
                    </select>
                </div>
            </div>
            <div class="loading" id="loadingChats"><div class="loading-spinner"></div><p>Buscando conversas...</p></div>
            <div id="emptyChats" class="empty" style="display:none;">Nenhuma conversa encontrada</div>
            <table id="chatsTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Plataforma/Origem</th>
                        <th>Status/Equipe</th>
                        <th>Agente</th>
                        <th>√öltima Mensagem</th>
                        <th>Iniciada</th>
                    </tr>
                </thead>
                <tbody id="chatsTableBody"></tbody>
            </table>
        </div>

        <div class="raw-data" id="rawData">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong>üìã Dados Recebidos da API OmniChat</strong>
                <button onclick="copyRawData()" style="padding: 5px 10px; font-size: 12px;">üìã Copiar</button>
            </div>
            <pre id="rawDataContent">Aguardando dados...</pre>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURA√á√ÉO - AJUSTE AQUI SUAS URLs
        // ============================================================================
        const CONFIG = {
            // URL do seu backend que consome a API OmniChat
            OMNICHAT_API_URL: 'https://api.muvecom.com.br/v1/omnichat-chats',
            // Caso tenha endpoint espec√≠fico para agentes (opcional)
            AGENTS_API_URL: 'https://api.muvecom.com.br/v1/omnichat-agents'
        };

        // Vari√°veis globais
        let lastData = null;
        let allChats = [];
        let allAgents = [];

        // ============================================================================
        // FUN√á√ÉO PRINCIPAL - CARREGA DADOS DO OMNICHAT
        // ============================================================================
        async function loadOmnichatData() {
            try {
                // Reset UI
                hideError();
                updateStatus('Conectando √† API OmniChat...', 'loading');
                document.getElementById('loadBtn').disabled = true;
                document.getElementById('loadBtn').innerHTML = 'üîÑ Buscando...';
                showLoading('agents', true);
                showLoading('chats', true);
                hideTable('agents');
                hideTable('chats');
                hideEmpty('agents');
                hideEmpty('chats');
                resetKPIs();

                // Tenta buscar de ambos endpoints, mas se um falhar, usa o principal
                let chatsData = null;
                let agentsData = null;

                try {
                    // Primeiro tenta o endpoint principal
                    chatsData = await fetchFromAPI(CONFIG.OMNICHAT_API_URL);
                } catch (error) {
                    console.warn('Erro no endpoint principal:', error);
                    throw new Error(`Falha ao conectar com a API OmniChat: ${error.message}`);
                }

                try {
                    // Tenta o endpoint de agentes (se configurado e se n√£o for o mesmo URL)
                    if (CONFIG.AGENTS_API_URL && CONFIG.AGENTS_API_URL !== CONFIG.OMNICHAT_API_URL) {
                        agentsData = await fetchFromAPI(CONFIG.AGENTS_API_URL);
                    }
                } catch (error) {
                    console.warn('Endpoint de agentes falhou, usando dados das conversas:', error);
                    agentsData = chatsData; // Usa os mesmos dados
                }

                // Processa os dados
                processAllData(chatsData, agentsData);
                
                updateStatus('‚úÖ Dados carregados com sucesso', 'online');
                updateTime();
                
                // Guarda para debug
                lastData = {
                    chats: chatsData,
                    agents: agentsData,
                    timestamp: new Date().toISOString(),
                    totalChats: chatsData.length || 0
                };
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showError(`Falha ao carregar dados: ${error.message}`, error.stack);
                updateStatus('‚ùå Erro na conex√£o', 'offline');
            } finally {
                document.getElementById('loadBtn').disabled = false;
                document.getElementById('loadBtn').innerHTML = 'üîÑ Carregar Dados OmniChat';
            }
        }

        async function fetchFromAPI(url) {
            console.log('Fetching from:', url);
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Verifica se √© array (formato OmniChat) ou se tem propriedade data
            if (Array.isArray(data)) {
                return data; // Formato direto da API
            } else if (data.data && Array.isArray(data.data)) {
                return data.data; // Formato envelopado
            } else if (data.results && Array.isArray(data.results)) {
                return data.results; // Outro formato poss√≠vel
            } else {
                console.warn('Formato de dados inesperado:', data);
                return []; // Retorna array vazio para n√£o quebrar
            }
        }

        // ============================================================================
        // PROCESSAMENTO DOS DADOS OMNICHAT
        // ============================================================================
        function processAllData(chatsData, agentsData) {
            // Garante que temos arrays
            const chats = Array.isArray(chatsData) ? chatsData : [];
            const agentsInput = Array.isArray(agentsData) ? agentsData : chats; // Fallback
            
            // Armazena dados globais
            allChats = chats;
            
            // Extrai agentes dos dados
            allAgents = extractAgentsFromData(chats, agentsInput);
            
            // Atualiza KPIs
            updateKPIs(chats, allAgents);
            
            // Renderiza tabelas
            renderAgentsTable(allAgents);
            renderChatsTable(chats);
        }

        function extractAgentsFromData(chats, agentsInput) {
            const agentsMap = new Map();
            
            // 1. Extrai dos usu√°rios nas conversas
            chats.forEach(chat => {
                if (chat.user && chat.user.objectId) {
                    const agentId = chat.user.objectId;
                    if (!agentsMap.has(agentId)) {
                        agentsMap.set(agentId, {
                            id: agentId,
                            name: chat.user.name || 'Sem nome',
                            lastName: chat.user.lastName || '',
                            email: chat.user.email || '--',
                            picture: chat.user.picture,
                            type: 'atendente',
                            status: chat.user.disabled === false ? 'ativo' : 'inativo',
                            lastActivity: chat.updatedAt,
                            createdAt: chat.user.createdAt || chat.createdAt
                        });
                    }
                }
                
                // 2. Extrai do customerSupportRequest
                if (chat.customerSupportRequest) {
                    const csr = chat.customerSupportRequest;
                    if (csr.contactedBy && csr.contactedBy.objectId) {
                        const agentId = csr.contactedBy.objectId;
                        if (!agentsMap.has(agentId)) {
                            agentsMap.set(agentId, {
                                id: agentId,
                                name: csr.contactedBy.name || 'Atendente',
                                lastName: csr.contactedBy.lastName || '',
                                email: '--',
                                type: 'contatado_por',
                                status: 'ativo',
                                lastActivity: csr.updatedAt,
                                createdAt: chat.createdAt
                            });
                        }
                    }
                    
                    // 3. Participating Users
                    if (csr.participatingUsers && Array.isArray(csr.participatingUsers)) {
                        csr.participatingUsers.forEach(user => {
                            if (user.objectId && !agentsMap.has(user.objectId)) {
                                agentsMap.set(user.objectId, {
                                    id: user.objectId,
                                    name: user.name || 'Participante',
                                    lastName: user.lastName || '',
                                    email: '--',
                                    type: 'participante',
                                    status: 'ativo',
                                    createdAt: chat.createdAt
                                });
                            }
                        });
                    }
                }
                
                // 4. Equipe
                if (chat.team && chat.team.users) {
                    chat.team.users.forEach(user => {
                        if (user.objectId && !agentsMap.has(user.objectId)) {
                            agentsMap.set(user.objectId, {
                                id: user.objectId,
                                name: user.name || 'Membro da Equipe',
                                lastName: user.lastName || '',
                                email: '--',
                                type: 'equipe',
                                status: 'ativo',
                                createdAt: chat.team.createdAt || chat.createdAt
                            });
                        }
                    });
                }
            });
            
            // 5. Adiciona agentes do endpoint espec√≠fico (se dispon√≠vel)
            if (Array.isArray(agentsInput) && agentsInput !== chats) {
                agentsInput.forEach(agent => {
                    if (agent.objectId && !agentsMap.has(agent.objectId)) {
                        agentsMap.set(agent.objectId, {
                            id: agent.objectId,
                            name: agent.name || 'Agente',
                            lastName: agent.lastName || '',
                            email: agent.email || '--',
                            picture: agent.picture,
                            type: 'agente',
                            status: agent.disabled === false ? 'ativo' : 'inativo',
                            createdAt: agent.createdAt
                        });
                    }
                });
            }
            
            return Array.from(agentsMap.values());
        }

        function renderAgentsTable(agents) {
            const tbody = document.getElementById('agentsTableBody');
            const loading = document.getElementById('loadingAgents');
            const table = document.getElementById('agentsTable');
            const empty = document.getElementById('emptyAgents');
            
            tbody.innerHTML = '';
            loading.style.display = 'none';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            if (!agents || agents.length === 0) {
                empty.style.display = 'block';
                return;
            }
            
            // Ordena por nome
            agents.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            
            agents.forEach(agent => {
                const row = document.createElement('tr');
                
                // Status badge
                const statusClass = agent.status === 'ativo' ? 'badge-success' : 'badge-danger';
                const statusText = agent.status === 'ativo' ? 'Ativo' : 'Inativo';
                
                // Tipo badge
                let typeBadge = '';
                if (agent.type === 'atendente') {
                    typeBadge = '<span class="badge badge-info">Atendente</span>';
                } else if (agent.type === 'equipe') {
                    typeBadge = '<span class="badge" style="background:#f3e8ff;color:#7c3aed;">Equipe</span>';
                } else {
                    typeBadge = `<span class="badge" style="background:#f0f9ff;color:#0369a1;">${agent.type}</span>`;
                }
                
                // Data formatada
                const created = agent.createdAt ? 
                    new Date(agent.createdAt).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    }) : '--';
                
                // Nome completo
                const fullName = `${agent.name || ''} ${agent.lastName || ''}`.trim() || 'Sem nome';
                
                row.innerHTML = `
                    <td class="agent-name">${fullName}</td>
                    <td>${typeBadge}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${agent.email || '--'}</td>
                    <td>${created}</td>
                `;
                tbody.appendChild(row);
            });
            
            table.style.display = 'table';
        }

        function renderChatsTable(chats) {
            const tbody = document.getElementById('chatsTableBody');
            const loading = document.getElementById('loadingChats');
            const table = document.getElementById('chatsTable');
            const empty = document.getElementById('emptyChats');
            
            tbody.innerHTML = '';
            loading.style.display = 'none';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            if (!chats || chats.length === 0) {
                empty.style.display = 'block';
                return;
            }
            
            // Ordena por data mais recente
            chats.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
            
            // Aplica filtros
            const filteredChats = applyChatFilters(chats);
            
            if (filteredChats.length === 0) {
                empty.style.display = 'block';
                empty.textContent = 'Nenhuma conversa corresponde aos filtros aplicados';
                return;
            }
            
            filteredChats.slice(0, 50).forEach(chat => {
                const row = document.createElement('tr');
                row.className = 'chat-row';
                
                // Informa√ß√µes do Cliente
                const customerName = chat.customer ? 
                    `${chat.customer.name || ''} ${chat.customer.lastName || ''}`.trim() : 
                    chat.name || 'Cliente';
                const customerPhone = chat.phone ? 
                    `+${chat.phone.countryCode || '55'} (${chat.phone.areaCode || ''}) ${formatPhoneNumber(chat.phone.phoneNumber)}` : 
                    (chat.customer ? `+${chat.customer.phoneCountryCode || '55'} (${chat.customer.phoneAreaCode || ''}) ${formatPhoneNumber(chat.customer.phoneNumber)}` : '--');
                
                // Plataforma e Origem
                const platform = chat.platform || '--';
                let originInfo = '--';
                if (chat.customerSupportRequest && chat.customerSupportRequest.origin) {
                    const origin = chat.customerSupportRequest.origin;
                    if (origin.type === 'ADS') {
                        originInfo = `An√∫ncio: ${origin.name || origin.channel || '--'}`;
                    } else if (origin.type === 'INBOUND') {
                        originInfo = 'Entrada Org√¢nica';
                    }
                }
                
                // Status e Equipe
                let statusBadge = '';
                let teamInfo = '';
                
                if (chat.status === 'FINISHED') {
                    statusBadge = '<span class="badge badge-danger">Finalizada</span>';
                } else if (chat.status === 'USER') {
                    statusBadge = '<span class="badge badge-success">Em Atendimento</span>';
                } else if (chat.status === 'TEAM') {
                    statusBadge = '<span class="badge badge-warning">Na Equipe</span>';
                } else {
                    statusBadge = '<span class="badge" style="background:#f3f4f6;color:#6b7280;">Aguardando</span>';
                }
                
                if (chat.team && chat.team.name) {
                    teamInfo = `<div class="team-name" title="${chat.team.name}">${truncateText(chat.team.name, 20)}</div>`;
                } else if (chat.customerSupportRequest && chat.customerSupportRequest.teamId) {
                    teamInfo = `<div class="team-name">Equipe: ${truncateText(chat.customerSupportRequest.teamId, 10)}</div>`;
                }
                
                // Agente Respons√°vel
                let agentInfo = '--';
                if (chat.user && chat.user.name) {
                    const agentName = `${chat.user.name || ''} ${chat.user.lastName || ''}`.trim();
                    agentInfo = `<span class="agent-name">${agentName}</span>`;
                } else if (chat.customerSupportRequest && chat.customerSupportRequest.contactedBy) {
                    const contactedByName = `${chat.customerSupportRequest.contactedBy.name || ''} ${chat.customerSupportRequest.contactedBy.lastName || ''}`.trim();
                    agentInfo = `<span>${contactedByName || 'Atendente'}</span>`;
                }
                
                // √öltima Mensagem
                let lastMessage = '--';
                if (chat.lastMessage) {
                    const msg = chat.lastMessage;
                    let msgText = '';
                    if (msg.type === 'TEXT') {
                        msgText = msg.text || '(sem texto)';
                    } else if (msg.type === 'ROUTING') {
                        msgText = `üì§ ${msg.text || 'Encaminhamento'}`;
                    } else if (msg.type === 'GROUPED') {
                        msgText = 'üìé Conte√∫do agrupado';
                    } else {
                        msgText = `${msg.type || 'Mensagem'}: ${msg.text || ''}`;
                    }
                    lastMessage = truncateText(msgText, 60);
                }
                
                // Data de Cria√ß√£o
                const createdAt = chat.createdAt ? 
                    new Date(chat.createdAt).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '--';
                
                row.innerHTML = `
                    <td>
                        <div class="customer-name">${customerName || 'Cliente'}</div>
                        <div class="customer-phone">${customerPhone}</div>
                    </td>
                    <td>
                        <div class="platform-badge">${platform}</div>
                        <small style="display:block;margin-top:4px;color:#6b7280;font-size:11px;">${originInfo}</small>
                    </td>
                    <td>
                        ${statusBadge}
                        ${teamInfo}
                    </td>
                    <td>${agentInfo}</td>
                    <td class="last-message" title="${lastMessage}">${lastMessage}</td>
                    <td style="white-space:nowrap;">${createdAt}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            table.style.display = 'table';
        }

        function applyChatFilters(chats) {
            const statusFilter = document.getElementById('filterStatus').value;
            const platformFilter = document.getElementById('filterPlatform').value;
            
            return chats.filter(chat => {
                // Filtro de status
                if (statusFilter !== 'all') {
                    if (statusFilter === 'WAITING') {
                        // Para WAITING, verifica tanto status WAITING quanto customerSupportRequest WAITING
                        const isWaiting = chat.status === 'TEAM' || 
                                         (chat.customerSupportRequest && chat.customerSupportRequest.status === 'WAITING');
                        if (statusFilter === 'WAITING' && !isWaiting) return false;
                    } else if (chat.status !== statusFilter) {
                        return false;
                    }
                }
                
                // Filtro de plataforma
                if (platformFilter !== 'all' && chat.platform !== platformFilter) {
                    return false;
                }
                
                return true;
            });
        }

        function filterChats() {
            if (allChats.length > 0) {
                renderChatsTable(allChats);
            }
        }

        // ============================================================================
        // FUN√á√ïES AUXILIARES
        // ============================================================================
        function updateKPIs(chats, agents) {
            // Total de conversas
            document.getElementById('kpiTotalChats').textContent = chats.length;
            
            // Conversas ativas (n√£o finalizadas)
            const activeChats = chats.filter(chat => 
                chat.status !== 'FINISHED' && 
                (!chat.customerSupportRequest || chat.customerSupportRequest.status !== 'FINISHED')
            ).length;
            document.getElementById('kpiActiveChats').textContent = activeChats;
            
            // Aguardando atendimento
            const waitingChats = chats.filter(chat => 
                chat.status === 'TEAM' || 
                (chat.customerSupportRequest && chat.customerSupportRequest.status === 'WAITING')
            ).length;
            document.getElementById('kpiWaiting').textContent = waitingChats;
            
            // Agentes ativos (com status ativo)
            const activeAgents = agents.filter(agent => agent.status === 'ativo').length;
            document.getElementById('kpiAgents').textContent = activeAgents;
        }

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            const phoneStr = phone.toString();
            if (phoneStr.length <= 8) return phoneStr;
            return phoneStr.replace(/(\d{4})(\d{4})/, '$1-$2');
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // ============================================================================
        // FUN√á√ïES DE UI
        // ============================================================================
        function updateStatus(text, type) {
            const dot = document.getElementById('statusDot');
            const textElem = document.getElementById('statusText');
            dot.className = 'status-dot ' + type;
            textElem.textContent = text;
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('kpiUpdated').textContent = 
                now.getHours().toString().padStart(2,'0') + ':' + 
                now.getMinutes().toString().padStart(2,'0');
        }

        function resetKPIs() {
            document.getElementById('kpiTotalChats').textContent = '0';
            document.getElementById('kpiActiveChats').textContent = '0';
            document.getElementById('kpiWaiting').textContent = '0';
            document.getElementById('kpiAgents').textContent = '0';
            document.getElementById('kpiUpdated').textContent = '--:--';
        }

        function showError(msg, details) {
            document.getElementById('errorMessage').textContent = msg;
            const det = document.getElementById('errorDetails');
            if (details) { 
                det.textContent = typeof details === 'string' ? details : JSON.stringify(details, null, 2); 
                det.style.display = 'block'; 
            } else { 
                det.style.display = 'none'; 
            }
            document.getElementById('errorBox').style.display = 'block';
        }

        function hideError() { 
            document.getElementById('errorBox').style.display = 'none'; 
        }

        function showLoading(type, show) { 
            const typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1);
            const element = document.getElementById(`loading${typeCapitalized}`);
            if (element) element.style.display = show ? 'block' : 'none'; 
        }

        function hideTable(type) { 
            document.getElementById(`${type}Table`).style.display = 'none'; 
        }

        function hideEmpty(type) { 
            const typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1);
            document.getElementById(`empty${typeCapitalized}`).style.display = 'none'; 
        }

        function toggleRawData() {
            const rd = document.getElementById('rawData');
            const isVisible = rd.style.display === 'block';
            rd.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible && lastData) {
                document.getElementById('rawDataContent').textContent = JSON.stringify(lastData, null, 2);
            }
        }

        function copyRawData() {
            const rawContent = document.getElementById('rawDataContent').textContent;
            navigator.clipboard.writeText(rawContent).then(() => {
                alert('Dados copiados para a √°rea de transfer√™ncia!');
            });
        }

        // ============================================================================
        // INICIALIZA√á√ÉO
        // ============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            
            // Verifica se as URLs est√£o configuradas
            if (!CONFIG.OMNICHAT_API_URL) {
                updateStatus('‚ö†Ô∏è Configure a URL da API OmniChat', 'offline');
                showError('Configure a URL da API OmniChat no in√≠cio do arquivo JavaScript (CONFIG.OMNICHAT_API_URL)', '');
            } else {
                updateStatus('üîÑ Pronto para carregar dados', 'offline');
                
                // Carrega dados automaticamente ap√≥s 1 segundo
                setTimeout(() => {
                    loadOmnichatData();
                }, 1000);
            }
        });

        // Carrega dados quando a p√°gina termina de carregar
        window.onload = function() {
            // Adiciona um pequeno delay para garantir que tudo est√° carregado
            setTimeout(() => {
                if (CONFIG.OMNICHAT_API_URL && !document.getElementById('errorBox').style.display) {
                    loadOmnichatData();
                }
            }, 500);
        };
    </script>
</body>
</html>
